#!/bin/sh

set -e

# original are: https://gist.github.com/jeffery/1115504
####
# Helper script to update the Last modified timestamp of files in a Git SCM
# Projects working Copy
#
# When you clone a Git repository, it sets the timestamp of all the files to the
# time when you cloned the repository.
#
# This becomes a problem when you want the cloned repository, which is part of a 
# Web application have a proper cacheing mechanism so that it can re-cache files
# (into a webtree) that have been modified since the last cache.
#
# @see http://stackoverflow.com/questions/1964470/whats-the-equivalent-of-use-commit-times-for-git
#
# Author: Jeffery Fernandez <jeffery@fernandez.net.au>
####

####
# Author: TsT worldmaster.fr <tst2005@gmail.com>
#
# Improvement :
# - dry-run by default (use -f to apply time change)
# - pass files to check as argument
# - do not time sync modified files
# - do not time sync untracked files
# - ...
#
# TODO:
# - Linux version improved, to the same for MacOS X and FreeBSD
# - ...
####

# Get the last revision hash of a particular file in the git repository
getFileLastRevision() {
	git rev-list HEAD -- "$1" | head -n 1
}

# Extract the actual last modified timestamp of the file and Update the time-stamp
# ... for Linux
updateFileTimeStamp() {
	# Extract the file revision
	local FILE_REVISION_HASH="$(getFileLastRevision "$1")"

	if [ ! -f "$1" ]; then
		echo >&2 "ERROR: target file does not exists. Unknown bug?!"
		return 1
	fi

	local tracked="$(git ls-files -t -c -- "$1")"
	if [ -z "$tracked" ]; then
		echo "?  $1"
		return
	fi

	# Extract the last modified timestamp
	# Get the File last modified time
	local FILE_MODIFIED_TIME="$(git show --pretty=format:%at --abbrev-commit ${FILE_REVISION_HASH} | head -n 1)"
	if [ -z "$FILE_MODIFIED_TIME" ]; then
		echo "?! $1 (not found in git)"
		return
	fi

	# Check if the file is modified
	local uncommited="$(git ls-files -t -dm -- "$1")"

	# for displaying the date in readable format
	#local FORMATTED_TIMESTAMP="$(date --date="${FILE_MODIFIED_TIME}" +'%d-%m-%Y %H:%M:%S %z')"
	local FORMATTED_TIMESTAMP="@${FILE_MODIFIED_TIME}"

	# Modify the last modified timestamp
	#echo "[$(date -d "$FORMATTED_TIMESTAMP")]: $1"
	#echo "$FILE_MODIFIED_TIME $1"
	local current_mtime="$(stat -c %Y -- "$1")"
	if $debug; then
		echo >&2 "DEBUG: $1 (git_time=$FILE_MODIFIED_TIME current_time=$current_mtime delta=$(( ${current_mtime:-0} - ${FILE_MODIFIED_TIME:-0} )))"
	fi
	if [ "$current_mtime" = "$FILE_MODIFIED_TIME" ]; then
		if ${verbose:-true}; then echo "ok $1"; fi
	elif [ -n "$uncommited" ]; then
		echo "C  $1 (modified, not commited, $(( $current_mtime - $FILE_MODIFIED_TIME ))s recent)"
	else
		if ${apply:-false}; then
			echo "!! $1 (desync: $(( $current_mtime - $FILE_MODIFIED_TIME ))s, syncing...)"
			touch -d "$FORMATTED_TIMESTAMP" -- "$1"
		else
			echo "!! $1 (desync: $(( $current_mtime - $FILE_MODIFIED_TIME ))s, no change)"
		fi
	fi
}

# ... for FreeBSD and Mac OS X
updateFileTimeStamp2() {
	# Extract the file revision
	local FILE_REVISION_HASH="$(getFileLastRevision "$1")"

	# Extract the last modified timestamp
	# Get the File last modified time
	local FILE_MODIFIED_TIME="$(git show --pretty=format:%ai --abbrev-commit ${FILE_REVISION_HASH} | head -n 1)"

	# Format the date for updating the timestamp
	local FORMATTED_TIMESTAMP="$(date -j -f '%Y-%m-%d %H:%M:%S %z' "${FILE_MODIFIED_TIME}" +'%Y%m%d%H%M.%S')"
		
	# Modify the last modified timestamp
	touch -t "${FORMATTED_TIMESTAMP}" -- "$1"
}

apply=false
verbose=true
debug=false
while [ $# -gt 0 ]; do
	case "$1" in
		-f) apply=true ;;
		-n) apply=false ;;
		--) shift; break ;;
		-v) verbose=true ;;
		-q) verbose=false ;;
		--debug) debug=true ;;
		*) break
	esac
	shift
done

# Make sure we are not running this on a bare Repository
case "$(git config core.bare)" in
	false)	;;
	true)
		echo "Cannot run this script on a bare Repository"
		exit 1
	;;
	*)	echo "Error appened during core.bare detection. Are you really inside a repository ?"
		exit 1
esac

#echo "Updating Git Repository Last Modified Time-stamp"

# Obtain the Operating System
case "${OS:-$(uname)}" in
	  'Linux') ;;
	  'Darwin'|'FreeBSD')
		updateFileTimeStamp() { updateFileTimeStamp2 "$@"; }
	  ;;
	  *)
		echo >&2 "Unknown Operating System to perform timestamp update"
		exit 1
esac

if [ $# -eq 0 ]; then
	# Loop through and fix timestamps on all files in our checked-out repository
	git ls-files \
	| (
	IFS="$(printf '\n')"
	while read -r file; do
	#for file in $(git ls-files); do
		updateFileTimeStamp "${file}"
	done
	)
else
	# Loop through and fix timestamps on all specified files
	for file in "$@"; do
		updateFileTimeStamp "${file}"
	done
fi

